<!-- 
  正常流程：这个页面是通过QQ登录后重定向而来，会自动给站点注入QQ登录状态的数据
  先加载，看有没有对应的用户
  1. 有，直接登录，获取token
  2. 没有，分两种情况，让用户选择
   ① 有本网站账号，启动绑定流程
    让用户输入账号密码
   ② 不是网站用户，启动注册流程
    让用户注册

  https://mylog.cool/#/login/qq-redirect
  #access_token=C8CB48CFEF31E123EA660E14218B493E
  &expires_in=7776000
  &state=login
 -->
<script setup lang="ts">
import QC from '@/utils/QQConnect'
import { haveUser, login, signin, updateOpenidQ } from '@/api/user'
import { ArrowLeftBold } from '@element-plus/icons-vue'
import { baseURL } from '@/stores/constant'

const route = useRoute()
const state = ref(0)
const user = reactive({ name: '', pswd: '', captcha: '' })
// 确认密码独立出来
const pswd2 = ref('')
const userdata = reactive<{
  info: any
  openidQ: string
  accessToken: string
}>({
  info: {},
  openidQ: '',
  accessToken: '',
})

const captchaDom = ref<HTMLImageElement | null>(null)

onMounted(() => {
  if (QC.Login.check()) {
    // 如果是登录状态
    QC.api('get_user_info').success((res: any) => {
      userdata.info = res.data // 用户头像
      console.log('🐤user info: ', res.data)

      QC.Login.getMe(async (openidQ, accessToken) => {
        userdata.openidQ = openidQ
        userdata.accessToken = accessToken
        // accessToken有有效时间，存入浏览器。openId唯一，存入数据库和账号绑定
        // localStorage.setItem('accessToken', accessToken)
        // 先看数据库有没有这个openId
        const count = await haveUser({ openidQ })
        if (count === 0) {
          state.value = 1 // ①选择已有账户 ②新建账户
        } else {
          console.log('🐤找到账号直接登录')
          login({ openidQ }).then(user => {
            localStorage.setItem('token', user.token!)
            // location.replace('/#' + (route.query.redirect || ''))
            location.href = '/'
          })
        }
      })
    })
  } else {
    // 用户没有QQ登录直接进入此页面
    location.replace('/#/login')
  }
})

// 1.绑定已有账号
const bd = () => {
  if (!user.name || !user.pswd) {
    ElMessage('用户名或密码不能为空')
    return false
  }
  // 先登录获取token，再token和openid一起绑定
  login({
    name: user.name,
    pswd: user.pswd,
  }).then(user => {
    const token = user.token

    console.log('🐤绑定')
    if (token) {
      updateOpenidQ({
        token,
        openidQ: userdata.openidQ,
      }).then(count => {
        if (count === 1) {
          ElMessage({ message: '绑定成功', type: 'success' })
          localStorage.setItem('token', token)
          location.replace('/')
        } else {
          ElMessage({ message: '绑定失败', type: 'error' })
        }
      })
    } else {
      ElMessage.error('用户名或密码不正确')
      return false
    }
  })
}

// 2.用户选择注册新用户
// 获取QQ名作为默认名字，叫他设置用户名（万一被占用了）和密码
const handleNew = () => {
  state.value = 3
  user.name = userdata.info.nickname
  haveUser({ name: user.name }).then(count => {
    if (count) ElMessage.error('该用户名被占用了哦')
  })
}
// 点击注册
const zc = async () => {
  // 普通校验
  if (!user.name.trim() || !user.pswd.trim() || !pswd2.value.trim()) {
    ElMessage.error('请输入相关信息')
    return false
  }
  if (user.pswd.trim() != pswd2.value.trim()) {
    ElMessage.error('两次密码不一致')
    return false
  }
  const userid = await signin(user)
  console.log(userid)
  if (userid === 0) {
    ElMessage.error('用户名已存在')
    return
  }
  if (userid === -1) {
    ElMessage.error('验证码错误')
    return
  }

  // 先登录获取token，再token和openid一起绑定
  login({
    name: user.name,
    pswd: user.pswd,
  }).then(user => {
    const token = user.token
    console.log('🐤绑定')
    if (token) {
      updateOpenidQ({
        token,
        openidQ: userdata.openidQ,
      }).then(count => {
        if (count === 1) {
          ElMessage({ message: '绑定成功', type: 'success' })
          localStorage.setItem('token', token)
          // 设置用户头像为QQ头像
          // myPost(
          //   '/user/set/img',
          //   { usertoken, value: user.data.figureurl_qq },
          //   () => {
          //     location.href = '/'
          //   }
          // )
          location.replace('/')
        } else {
          ElMessage({ message: '绑定失败', type: 'error' })
        }
      })
    } else {
      ElMessage.error('用户名或密码不正确')
      return false
    }
  })
}

//刷新验证码
const changeImg = () => {
  captchaDom.value!.src = baseURL + '/user/signin/captcha_img?' + Math.random()
}
onMounted(changeImg)
</script>

<template>
  <StructLogin>
    <!-- {{ user }} -->
    <div class="title">
      <ElButton
        v-if="state > 1"
        :icon="ArrowLeftBold"
        @click="state = 1"
        text
        circle
      />QQ登录
    </div>

    <div
      class="qq-redirect"
      v-loading="state === 0"
      element-loading-background="transparent"
    >
      <form v-if="state === 1">
        <div class="title2">没有找到对应的用户</div>
        <div>以前有注册过本网站吗？有的话我们直接给您绑定QQ</div>
        <ElButton @click="state = 2" size="large">绑定已有账号</ElButton>
        <ElButton @click="handleNew" size="large">注册新用户</ElButton>
      </form>

      <!-- 绑定已有 -->
      <form v-if="state == 2">
        <div class="title2">绑定已有账号</div>
        <input
          type="text"
          class="username"
          v-model="user.name"
          autocomplete="off"
          placeholder="用户名"
        />
        <input
          type="password"
          class="password"
          v-model="user.pswd"
          autocomplete="off"
          placeholder="密码"
        />
        <ElButton @click="bd" size="large">绑定并登录</ElButton>
      </form>

      <!-- 注册新用户 -->
      <form v-if="state == 3">
        <div class="title2">注册新用户</div>
        <input
          type="text"
          v-model="user.name"
          autocomplete="off"
          placeholder="用户名"
        />
        <input
          type="password"
          v-model="user.pswd"
          autocomplete="off"
          placeholder="密码"
        />
        <input
          type="password"
          v-model="pswd2"
          autocomplete="off"
          placeholder="确认密码"
        />
        <div class="captcha">
          <input
            v-model="user.captcha"
            placeholder="验证码"
            type="text"
            autocomplete="off"
          />
          <img ref="captchaDom" alt="验证码看不清，换一张" @click="changeImg" />
        </div>
        <ElButton class="btn" @click="zc">注册并登录</ElButton>
      </form>
    </div>
  </StructLogin>
</template>

<style scoped lang="less">
.title {
  font-size: 2.5em;
  font-weight: bold;
  margin-bottom: 20px;

  display: flex;
  align-items: center;
  gap: 12px;
}

.qq-redirect {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 24px;

  .title2 {
    font-size: 1.3em;
  }

  > form {
    display: flex;
    flex-direction: column;
    gap: 24px;

    input {
      color: var(--color-text);
      background-color: #8882;
      font-size: 1.2rem;
      padding: 12px;
      border-radius: 6px;
      border: none;
      outline: none;
      transition: all 0.5s;

      /* 去除自动浏览器自动填充添加的样式 */
      &:-webkit-autofill,
      &:-webkit-autofill:hover,
      &:-webkit-autofill:focus,
      &:-webkit-autofill:active {
        -webkit-transition-delay: 99999s;
        -webkit-transition: color 99999s ease-out,
          background-color 99999s ease-out;
      }

      &:focus,
      &:hover {
        box-shadow: 1px 1px 2px 2px #0001;
      }
    }
  }
}
</style>
